<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Forms Hub</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
  <style>
    body { background:#f6f7f9; }
    header { padding: 1.2rem 0 0; }
    .grid { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
    .tag { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#eef0f4; }
    .muted { color:#6b7280; font-size:12px; }
    .error { background:#fee2e2; color:#991b1b; padding:.8rem; border-radius:.5rem; }
    .searchbar { display:flex; gap:.6rem; align-items:center; }
  </style>
</head>
<body>
  <main class="container">
    <header>
      <h2>ğŸ“‹ ç¤¾å†…ãƒ•ã‚©ãƒ¼ãƒ  Hub</h2>
      <p class="muted">å„éƒ¨ç½²ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã¾ã¨ã‚ã¦ä¸€è¦§ã€‚æ¤œç´¢ã‚„ã‚«ãƒ†ã‚´ãƒªã§çµã‚Šè¾¼ã¿ã§ãã¾ã™ã€‚</p>
      <div class="searchbar">
        <input id="q" placeholder="æ¤œç´¢ï¼ˆä¾‹: æ¤œæŸ», è³¼è²·, MB46Vï¼‰" aria-label="æ¤œç´¢">
        <select id="cat">
          <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
        </select>
      </div>
    </header>

    <div id="list" class="grid"></div>
    <div id="msg"></div>
  </main>

  <script>
    const qs = (s)=>document.querySelector(s);
    const listEl = qs('#list');
    const msgEl = qs('#msg');
    const qEl = qs('#q');
    const catEl = qs('#cat');
    let FORMS = [];

    function normalize(s){ return (s||'').toString().toLowerCase(); }

    function render(items){
      if(!Array.isArray(items) || items.length===0){
        listEl.innerHTML = '<article><div class="error">ãƒ•ã‚©ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚forms.json ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div></article>';
        return;
      }
      listEl.innerHTML = items.map(f => `
        <article>
          <header><strong>${f.title || '(ç„¡é¡Œãƒ•ã‚©ãƒ¼ãƒ )'}</strong></header>
          ${f.desc ? `<p class="muted">${f.desc}</p>` : ''}
          ${f.category ? `<span class="tag">${f.category}</span>` : ''}
          ${f.updatedAt ? `<p class="muted">æ›´æ–°æ—¥: ${f.updatedAt}</p>` : ''}
          <footer>
            <a href="${f.url}" role="button">é–‹ã</a>
          </footer>
        </article>
      `).join('');
    }

    function applyFilter(){
      const q = normalize(qEl.value);
      const cat = catEl.value;
      const filtered = FORMS.filter(f => {
        if(cat && (f.category||'') !== cat) return false;
        const hay = normalize([f.title, f.slug, f.desc, f.category].join(' '));
        return hay.includes(q);
      });
      render(filtered);
    }

    function fillCategories(){
      const cats = Array.from(new Set(FORMS.map(f => f.category).filter(Boolean))).sort();
      catEl.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    async function boot(){
      try{
        const res = await fetch('forms.json?v=' + Date.now());
        if(!res.ok) throw new Error('forms.json ã‚’å–å¾—ã§ãã¾ã›ã‚“ (' + res.status + ')');
        FORMS = await res.json();
        // sort by title
        FORMS.sort((a,b)=> (a.title||'').localeCompare(b.title||''));
        fillCategories();
        render(FORMS);
        qEl.addEventListener('input', applyFilter);
        catEl.addEventListener('change', applyFilter);
      }catch(err){
        msgEl.innerHTML = '<div class="error">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err.message + '</div>';
      }
    }
    boot();
  </script>
</body>
</html>
